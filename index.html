<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>chill.</title>
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css?family=Pacifico" rel="stylesheet">
  </head>
  <body>
    <div id="preamble" class="preamble">
      <h1>chill.</h1>

      <div id="settings">
        <p>Press <b>X</b> to reset the trace, <b>C</b> to cycle through colours,
          <b>V</b> to toggle the settings.<br>
        <p>
          <span>decay</span>
          <input id="decay" type="range" min="1" max="30" step="1" value="10">
          <span id="decayDisplay" class="slider-value">10s</span>

          <span style="margin-left: 20px">size</span>
          <input id="pixelSize" type="range" min="11" max="50" step="1" value="15">
          <span id="pixelSizeDisplay" class="slider-value">15px</span>
        </p>
      </div>
      <div id="colorsContainer"></div>
    </div>

    <div id="container"></div>
  </body>

  <script>
    const COLORS = [
      { name: 'black', hex: '#000000'},
      { name: 'red', hex: '#f44336'},
      { name: 'pink', hex: '#E91E63'},
      { name: 'purple', hex: '#9C27B0'},
      { name: 'deeppurple', hex: '#673AB7'},
      { name: 'indigo', hex: '#3F51B5'},
      { name: 'blue', hex: '#2196F3'},
      { name: 'lightblue', hex: '#03A9F4'},
      { name: 'cyan', hex: '#00BCD4'},
      { name: 'teal', hex: '#009688'},
      { name: 'green', hex: '#4CAF50'},
      { name: 'lightgreen', hex: '#8BC34A'},
      { name: 'lime', hex: '#CDDC39'},
      { name: 'yellow', hex: '#FFEB3B'},
      { name: 'amber', hex: '#FFC107'},
      { name: 'orange', hex: '#FF9800'},
      { name: 'deeporange', hex: '#FF5722'},
      { name: 'brown', hex: '#795548'},
      { name: 'grey', hex: '#9E9E9E'}
    ]
    var activeColor = 0;

    window.onresize = redrawBoard;
    window.onkeyup = dealWithKeyboardMash;
    decay.addEventListener('input', updateDecay);
    pixelSize.addEventListener('input', updatePixelSize);

    drawPreamble();
    redrawBoard();

    function dealWithKeyboardMash(e) {
      var key = e.keyCode ? e.keyCode : e.which;
      if (key == 88) {  // x
        resetTraces();
      } else if (key == 67) {  // c
        cycleColour();
      } else if (key == 86) {  // v
        toggleSettings();
      }
    }

    function redrawBoard() {
      var size = parseInt(pixelSize.value);
      var preambleSize = preamble.getBoundingClientRect()
      var topPadding = preambleSize.height + preambleSize.top;
       /* the 1px is for the border */
      var width = Math.floor((window.innerWidth) / (size + 1));
      var height = Math.floor((window.innerHeight - topPadding) / (size + 1));

      // Draw a grid of pixels.
      container.innerHTML = '';
      for (var i = 0; i < height; i++) {
        for (var j = 0; j < width; j++) {
          var box = document.createElement('div');
          box.tabindex = 1;
          box.className = 'box black';
          box.style.width = box.style.height = size + 'px';
          container.appendChild(box);
        }
        // Eh why not.
        container.appendChild(document.createElement('br'));
      }
      focusBoard();
    }

    // Lay out the "available colours" container.
    function drawPreamble() {
      for (var i = 0; i < COLORS.length; i++) {
        var box = document.createElement('div');
        box.style.backgroundColor = COLORS[i].hex;
        if (i == 0) {
          box.className = 'active';
        }
        colorsContainer.appendChild(box);
      }
    }

    // Trigger a repaint to reset the animations.
    function resetTraces() {
      container.style.display = 'none';
      container.offsetHeight;
      container.style.display = 'block';
    }

    function cycleColour() {
      var all = container.querySelectorAll('.box');
      var colorBoxes = colorsContainer.querySelectorAll('div');

      // Highight the next active colour.
      colorBoxes[activeColor].className = '';
      activeColor = (activeColor === COLORS.length - 1) ? 0 : activeColor + 1;
      colorBoxes[activeColor].className = 'active';

      // Apply it to all the pixels.
      for (var i = 0; i < all.length; i++) {
        all[i].className = 'box ' + COLORS[activeColor].name;
      }
    }

    function toggleSettings() {
      settings.hidden = !settings.hidden;
      redrawBoard();
    }

    function focusBoard() {
      container.focus();
    }

    function updateDecay() {
      decayDisplay.textContent = decay.value + 's';
      container.style.transitionDuration = decay.value + 's';
      focusBoard();
    }

    function updatePixelSize() {
      redrawBoard();
      focusBoard();
      pixelSizeDisplay.textContent = pixelSize.value + 'px';
    }
  </script>

</html>
